<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Able Carry Try-On</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; }
    body { margin: 0; background: #050505; color: #f5f5f5; display: flex; justify-content: center; min-height: 100vh; }
    .wrapper { width: 100%; max-width: 980px; padding: 24px 16px 40px; }
    h1 { margin: 0 0 8px; font-size: 1.8rem; }
    .subtitle { margin: 0 0 18px; color: #a0a0a0; line-height: 1.35; }

    .card {
      background: #101010;
      border-radius: 12px;
      border: 1px solid #262626;
      padding: 16px 18px 20px;
      margin-bottom: 20px;
    }

    label { display:block; margin: 10px 0 8px; font-size: 0.95rem; color: #e0e0e0; }

    input[type="file"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #333;
      background: #181818;
      color: #fff;
      font-size: 0.95rem;
    }

    button {
      margin-top: 12px;
      padding: 10px 18px;
      border-radius: 999px;
      border: none;
      background: #4f46e5;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      font-size: 0.98rem;
    }
    button:disabled { opacity: .5; cursor: default; }

    .secondary-btn {
      background: #1a1a1a;
      border: 1px solid #333;
    }

    .status {
      margin-top: 10px;
      font-size: .9rem;
      color: #bbb;
      min-height: 1.2em;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 6px;
    }

    .opt {
      border: 1px solid #2b2b2b;
      border-radius: 14px;
      background: #0c0c0c;
      cursor:pointer;
      overflow: hidden;
      transition: transform 120ms ease, border-color 120ms ease;
    }
    .opt:hover { transform: translateY(-1px); }
    .opt.selected {
      outline: 2px solid #4f46e5;
      border-color: #4f46e5;
    }

    .opt img {
      width: 100%;
      height: 160px;
      object-fit: contain;
      padding: 12px;
      background:#0b0b0b;
    }

    .opt-body { padding: 12px 12px 14px; }
    .opt-title { font-weight: 800; font-size: 1.02rem; }
    .opt-sub { color:#9a9a9a; margin-top: 6px; font-size: 0.88rem; }

    .preview {
      max-width: 100%;
      max-height: 560px;
      border-radius: 12px;
      border: 1px solid #333;
      display:none;
      margin-top: 12px;
      background:#0b0b0b;
    }

    .hint {
      color:#7a7a7a;
      font-size:0.85rem;
      margin-top:6px;
      line-height:1.35;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Able Carry Try-On</h1>
    <div class="subtitle">
      Choose a bag and upload your photo.  
    </div>

    <div class="card">
      <form id="form">
        <label>1) Choose bag</label>
        <div class="grid" id="grid"></div>

        <label>2) Upload your photo</label>
        <input id="userImage" type="file" accept="image/*" />
        <div class="hint">Best: clear shoulders visible, simple background.</div>

        <button id="btn" type="submit">Generate</button>
        <div class="status" id="status"></div>
      </form>
    </div>

    <div class="card">
      <label>Output</label>
      <img id="out" class="preview" />
      <button id="downloadBtn" class="secondary-btn" type="button" style="display:none;">
        Download
      </button>
      <div class="status" id="outStatus">No image generated yet.</div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const PRODUCTS = [
        { option: 1, name: "Bag 01", img: "/static/products/thumbs/bag-01.png" },
        { option: 2, name: "Bag 02", img: "/static/products/thumbs/bag-02.png" },
      ];

      const grid = document.getElementById("grid");
      const form = document.getElementById("form");
      const btn = document.getElementById("btn");
      const status = document.getElementById("status");
      const out = document.getElementById("out");
      const outStatus = document.getElementById("outStatus");
      const userImage = document.getElementById("userImage");
      const downloadBtn = document.getElementById("downloadBtn");

      let selectedOption = PRODUCTS[0].option;
      let latestDownloadUrl = null;

      function renderOptions() {
        grid.innerHTML = "";
        PRODUCTS.forEach(p => {
          const div = document.createElement("div");
          div.className = "opt" + (p.option === selectedOption ? " selected" : "");
          div.innerHTML = `
            <img src="${p.img}" alt="${p.name}">
            <div class="opt-body">
              <div class="opt-title">${p.name}</div>
              <div class="opt-sub">Switch Path = ${p.option}</div>
            </div>
          `;
          div.onclick = () => {
            selectedOption = p.option;
            document.querySelectorAll(".opt").forEach(x => x.classList.remove("selected"));
            div.classList.add("selected");
          };
          grid.appendChild(div);
        });
      }
      renderOptions();

      function triggerDownload(url) {
        const a = document.createElement("a");
        a.href = url;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      downloadBtn.addEventListener("click", () => {
        if (latestDownloadUrl) triggerDownload(latestDownloadUrl);
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const file = userImage.files && userImage.files[0];
        if (!file) return alert("Please upload your photo.");

        status.textContent = "Generating...";
        btn.disabled = true;
        out.style.display = "none";
        downloadBtn.style.display = "none";
        outStatus.textContent = "Generating...";
        latestDownloadUrl = null;

        try {
          const fd = new FormData();
          fd.append("userImage", file);
          fd.append("productOption", String(selectedOption));

          const res = await fetch("/api/generate", { method: "POST", body: fd });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Generation failed");

          const downloadUrl = data.imageUrl;
          latestDownloadUrl = downloadUrl;

          // Fetch as blob for preview
          const blobRes = await fetch(downloadUrl);
          const blob = await blobRes.blob();
          const objectUrl = URL.createObjectURL(blob);

          out.src = objectUrl;
          out.style.display = "block";
          downloadBtn.style.display = "inline-block";

          // Auto-download once
          triggerDownload(downloadUrl);

          status.textContent = "Done âœ…";
          outStatus.textContent = "";
        } catch (err) {
          console.error(err);
          status.textContent = "Error: " + (err.message || String(err));
          outStatus.textContent = "Generation failed.";
        } finally {
          btn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
